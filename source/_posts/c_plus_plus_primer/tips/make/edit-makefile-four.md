---
title: 《跟我一起写makefile (四)》摘抄
date: 2019-06-03 20:32:37
categories:
- C/C++
- C++
- 积累
tags:
- C++
- makefile
---

# 书写规则

&emsp;&emsp;规则包含两部分, 一个是依赖关系, 一个是生成目标的方法。

&emsp;&emsp;在 Makefile 中, 规则的顺序是很重要的。因为 Makefile 应该只有一个最终目标, 其他的目标都是被这个目标所连带出来的, 所以一定要让 make 知道你的最终目的是什么。一般来说, 定义在 Makefile 中的目标可能会有很多, 但是第一条规则中的目标将被确立为最终目标。如果第一条规则中的目标有很多个, 那么第一个目标会成为最终目标, make 所完成的也就是这个目标。

<!--more-->

## 一、规则举例

```
foo.o : foo.c defs.h
	cc -c -g foo.c
```

## 二、在规则中使用通配符

make 支持三个通配符: `*`, `?`, `...`, 这是和 Unix 的 B-Shell 是相同的。

波浪号 `~` 代表的是当前用户下的目录, `~test` 表示 test 用户下的目录, 而在 Windows 或 MS-DOS 下所指的目录根据环境变量 HOME 而定。

举例:

```
clean:
	rm -f *.o
```

> 删除所有后缀是.o的文件

```
print: *.c
	lpr -p $?
	touch print
```

> 通配符在规则中也支持, 目标print依赖所有的.c文件

```
objects = *.o
```

> 这样写, 通配符并不会被展开, 而是只去匹配*.o的文件, 如果想在变量中使用通配符, 可以这样:
> objects := $(wildcard *.o)

# 三、文件搜寻

在一些大的工程中, 有大量的源文件, 我们通常的做法是把这许多的源文件分类, 并存放在不同的目录中。所以当 make 需要去找寻文件的依赖关系时, 你可以在文件前加上路径, 但最好的方法是把一个路径告诉 make, 让 make 自动去找。

Makefile 文件中的特殊变量 "VPATH" 就是完成这个功能的， 如果没有指明这个变量, make 只会在当前的目录中去找依赖文件和目标文件, 如果定义了这个变量, 那么 make 就会在当前目录中找不到的情况下, 到所指定的目录去找寻文件了。

> VPATH = src:../headers

上面的定义指定了两个目录, "src" 和 "../headers", make 会按照这个顺序进行搜索, 目录由 `:` 分割。

另一个设置文件搜索路径的方法是使用 make 的 "vpath" 关键字, 这是 make 的一个关键字, 比上面提到的 VPATH 更为灵活, 可以指定不同文件在不同的搜索目录中。它的使用方法有三种:

* `vpath <pattern> <directories>`

> 为符合模式`<pattern>`的文件指定搜索目录`<directories>`

* `vpath <pattern>` 

> 清除符合模式`<>`
